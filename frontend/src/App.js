import { useState } from 'react';
import process from 'process';
import axios from 'axios';

export default function App() {
  const [searchValue, setSearchValue] = useState('');
  const [exploits, setExploits] = useState([]);
  const [error, setError] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [showResults, setShowResults] = useState(false);
  const [showOnlyExploits, setShowOnlyExploits] = useState(false);

  const isDev = process.env.NODE_ENV == 'development';
  const api = isDev ? 'http://localhost:8000' : 'https://wes-api.cooperbeltra.me';

  async function search() {
    setError('');

    try {
      setIsLoading(true);

      const { data: { success, message, data } } = await axios.post(api + '/search', {
        data: searchValue
      });

      setIsLoading(false);

      if (!success || message) {
        setShowResults(false);
        setIsLoading(false);
        return setError(message);
      }

      setExploits(data.exploits);
      setShowResults(true);
    } catch (err) {
      setShowResults(false);
      setIsLoading(false);
      setError(err.message);
    }
  }

  async function pasteClipboard() {
    const text = await navigator.clipboard.readText();

    setSearchValue(text.trim());
  }

  return (
    <div className="app">
      <h1>Windows Exploit Search</h1>
      <p className='subheading'>
        This website helps search through Microsoft Security
        Bulletins (MSSB's) to find relevant vulnerabilities
        and exploits to use against Windows target machines.
      </p>
      <p className='muted'>
        Run 'systeminfo' on the target machine and copy it's
        output into the form below.
      </p>
      <textarea
        type="text"
        value={searchValue}
        onClick={pasteClipboard}
        onInput={(e) => setSearchValue(e.target.value.trim())}
      />
      <button onClick={search} disabled={isLoading}>
        {
          isLoading ? <div className='loader'></div> : 'Search'
        }
      </button>
      <p className='error'>{error}</p>

      {
        !(!showResults || isLoading) ?
        <div className='result-container'>
          <hr />
          <div style={{display: 'flex', height: 38}}>
          <p className='exploit-count' style={{flex: 1, margin: 'auto'}}>{!showOnlyExploits ? `Showing ${exploits.length} vulnerabilities(s) and ` : 'Showing '} {exploits.filter(e => e.pocs.length > 0).length} exploit(s).</p>
          <button className='toggle-buttons' onClick={() => setShowOnlyExploits(!showOnlyExploits)}>Toggle Exploits</button>
          </div>
          {
            exploits.map(exploit => <ExploitItem exploit={exploit} />)
          }
        </div>
        : ''
      }
    </div>
  );

  function ExploitItem({ exploit }) {
    const sevcol = {
      "Critical": "red",
      "Moderate": "orange",
      "Important": "yellowgreen"
    };

    const date = `${exploit.date.substring(6, 8)}/${exploit.date.substring(4, 6)}/${exploit.date.substring(0, 4)}`;
    const pocs = exploit.pocs.split(',');
    const style = {};

    // if showExploitsOnly == true and there are no pocs, hide the item
    if (showOnlyExploits && pocs.length == 1) {
      style.display = "none";
    }

    // if showExploitsOnly == false, show all items
    if (!showOnlyExploits) {
      style.display = "block";
    }

    return (
      <div className='exploit-item' style={style}>
        <p className='exploit-name'>{exploit.title.split('Could')[0].split('(')[0]}</p>
        <p><a target="_blank" href={"https://nvd.nist.gov/vuln/detail/" + exploit.cve}>{exploit.cve}</a> · <span style={{color: sevcol[exploit.severity]}}>{exploit.severity}</span> · KB{exploit.kb}</p>
        
        <p style={{marginTop: 6}}><strong>Published</strong>: {date}</p>
        <p><strong>Impact</strong>: {exploit.impact}</p>
        <p><strong>Affected Component</strong>: {exploit.affected_component || 'N/A'}</p>

        {
          pocs.length > 1 ?
          <>
            <strong style={{marginTop: 8}}>Resources:</strong>
          <ul>
            {
              pocs.map(poc => <li><a className='dont-break-out' target="_blank" href={poc}>{poc}</a></li>)
            }
          </ul>
          </> : ''
        }
      </div>
    )
  }
}