const fs = require('fs');
const cors = require('cors');
const express = require('express');
const exec = require('child_process').exec;
const rateLimit = require('express-rate-limit');

// init express api
const api = express();

// create rate limit
const limiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 hour
  max: 80,
  standardHeaders: true,
  legacyHeaders: false
});

// setup api
api.use(cors());
api.options('*', cors())
api.use(limiter);
api.use(express.json());

// setup endpoints
api.get('/', (req, res) => {
  res.redirect('https://wes.cooperbeltra.me');
});

api.get('/ping', (req, res) => {
  res.json({
    success: true,
    message: 'Pong!',
    data: []
  });
});

api.post('/search', (req, res) => {
  const ostext = req.body.data;

  // write file to /tmp dir because 
  fs.writeFileSync('/tmp/systeminfo.txt', ostext);

  // perform wesng command and parse output
  exec('python ./wesng/wes.py -e --definitions ./wesng/definitions.zip /tmp/systeminfo.txt', (error, stdout, stderr) => {

    // handle errors
    if (error || stderr) {
      console.log(error, stderr);

      return res.json({
        success: false,
        message: "Error occured while reading input. Please try again.",
        data: []
      });
    }
    
    // parse command output
    const parsed = JSON.parse(stdout.replaceAll(`'`, `"`));

    res.json({
      success: true,
      message: "",
      data: parsed
    });
  });
});

// setup api listener
api.listen(8000, () =>{
  console.clear();
  console.log('Started listening on port 8000');
});